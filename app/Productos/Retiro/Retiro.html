<link rel="stylesheet" type="text/css" href="../../assets/icoMoon/style.css">
<style type="text/css">
    *{
        margin: 0px;
        padding: 0px;
    }

.productos-retiro {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: 30px 47px auto 30px;
    grid-column-gap: 0px;
    grid-row-gap: 0px;
    padding: 0px;
    height: 100vh;
}


.ventana-informativa {
    grid-area: 1 / 1/ 2 / 6;
    display: flex;
    align-items: center;
    flex-direction: row;
    justify-content: space-around;
}

.ventana-info1 {
    margin-left: 7px;
    font-size: 19px;
    font-weight: bolder;
}

.ventana-info2 {
    margin-left: 7px;
    font-size: 19px;
    font-weight: bolder;
}


.container-search-retiro {
    grid-area: 2 / 1 / 2 / 6;
    display: grid;
    grid-template-columns: 1fr repeat(3, 68px);
    grid-template-rows: 1fr;
    grid-column-gap: 3px;
    grid-row-gap: 3px;
    background: white;
    padding: 4px;
    /* margin-top: 4px; */
}

.input-text{
    padding: 4.5px;
}

.btn-product-retiro-action{

}

.Buscar{ color:white; background:orange;}
.Aceptar{ color:white; background: blue;}
.Cancelar{ color:white; background: red; }


.container-list-product-retiro {
    background: grey;
    grid-area: 3 / 1 / 6 / 6;
 
}

.container-producto-item {
    display: grid;
    grid-template-columns: 0.3fr 0.5fr repeat(6, 1fr);
    grid-template-rows: 1fr;
    grid-column-gap: 1px;
    grid-row-gap: 0px;
}


.container-producto-item {
    background: grey;
    font-weight: bold;
    margin-bottom: 5px;
}

.container-list-product-article {
    background: grey;
    height: 79vh;

}

.article-product-data {
    font-weight: bold;
    margin-bottom: 2px;
   display: grid;
    grid-template-columns: 0.3fr 0.5fr repeat(6, 1fr);
    grid-template-rows: 1fr;
    grid-column-gap: 1px;
    grid-row-gap: 0px;
}

.item-product-data {
    background: white;
    padding: 4px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.borrar-article{
    background: red;
    color: white;
    width: 90%;
    padding: 5px;
   /* border-style: none;*/
}

.Resultado-data-compra {
    grid-area: 4 / 1 / 6 / 6;
    background: #ffffff;
    padding: 1px;
    display: flex;
    align-items: center;
    justify-content: space-around;
    flex-direction: row;
}

.label-resultado {
    font-weight: bold;
    font-size: 27px;
}
/*--------------------------------------------------------*/
    /* Fondo oscuro del modal */
    .modal-overlay {
      display: none; /* oculto por defecto */
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    /* Contenedor principal */
#container-producto-buscado {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: stretch;
}

#container-producto-buscado>h1 {
    font-size: 30px;
    margin-bottom: 15px;
} 

.containner-data-nodal-retiro {
    display: flex;
    margin-bottom: 10px;
    font-weight: bold;
    flex-direction: row;
    align-items: center;
}

.nombre-modal-producto {
    font-weight: normal;
    margin-left: 5px;
    color: #333;
    font-size: 26px;
}

.cantidad {
    width: 30%;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-left: 12px;
}

.btn-cerrar-modal {
    margin-top: 15px;
    padding: 7px 6px;
    background: #409243;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18;
}

.btn-cerrar-modal:hover {
    background: #005fa3;
}

.Precio-producto-modal {
    margin-left: 9.2px;
    font-size: 25px;
}
.Descuento-producto-modal{

    margin-left: 6.5px;

}
.Precio-producto-modal-simbolo {
    margin-left: 6.5px;
}

/*---------------------------------------------------*/
 /*-------------------------MODAL2---------------------------------------*/
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; /* Permanece fijo en la pantalla */
            z-index: 1; /* Se superpone a otros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita el scroll si es necesario */
            background-color: rgba(0,0,0,0.4); /* Fondo semi-transparente */
            padding-top: 60px;
        }

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 10px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 10px;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
}
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* Estilos para el formulario */
        .modal-content label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        .modal-content input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            display: inline-block;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Asegura que padding no aumente el width */
            border-radius: 4px;
        }

        .btn-abrir {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-abrir:hover {
            background-color: #0056b3;
        }

.btn-guardar-venta {
    background-color: #28a745;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    float: right;
    width: 100%;
}
 /*----------------------------------------------------------------*/
</style>

<section class="productos-retiro" id="productosdata">
    <div class="ventana-informativa">

        <div class="ventana-info1" id="data-ventana1-info">
            
        </div> 
        <div class="ventana-info2" id="data-ventana2-info">
            <div id="reloj">00:00:00</div>
        </div>
        
    </div>
    <div class="container-search-retiro">
        <input  id="inputSearch" class="input-text" placeholder="Codigo o Nombre de Producto" type="search">
        <button class="btn-product-retiro-action Buscar icon-search" id="btn-Buscar">Bucar</button>
        <button class="btn-product-retiro-action Aceptar icon-checkmark" id="btn-Aceptar">Acepar</button>
        <button class="btn-product-retiro-action Cancelar icon-cross" id="btn-Limpiar">Cancelar</button>
    </div>

    <div class="container-list-product-retiro">
        
        <div class="container-producto-item">
            <span class="item-product-data">N</span>
            <span class="item-product-data">cod</span>
            <span class="item-product-data">Nombre</span>
            <span class="item-product-data">Precio</span>
            <span class="item-product-data">Descuento</span>
            <span class="item-product-data">cant</span>
            <span class="item-product-data">Totalprecio</span>
            <span class="item-product-data">Action</span>
        </div>  
       <!----->
        <div class="container-list-product-article" id="list_product_retiro"></div> 
    </div>

    <!----------------------------->
    <div class="Resultado-data-compra">
        <label class="label-resultado">
            <span class="Precio_Total">Total</span>
            <span class="Precio_Total" id="Precio_Total">0.00</span>
            <span>Bs</span>
        </label>        
        <label class="label-resultado">
            <span class="Cantidad_producto">cant.</span>
            <span id="cantidad_total_producto">5</span>
        </label>        
    </div>

<!----------------------------------->
<div class="modal-overlay" id="modalOverlay">
    <div id="container-producto-buscado">
        <h1>Producto seleccionado</h1>
        <label class="containner-data-nodal-retiro">
        cod:
        <span class="cod-modal-producto" id="cod_modal_producto">00000000</span>
        </label>  
        <label class="containner-data-nodal-retiro">
        Nombre:
        <span class="nombre-modal-producto" id="nombre_modal_producto"></span>
        </label>

        <label class="containner-data-nodal-retiro">
        Precio:
        <span class="Precio-producto-modal" id="Precio_producto_modal">0.00</span>
        <span class="Precio-producto-modal-simbolo" id="Simbolo_Precio_producto_modal">Bs</span>
        </label>

        <label class="containner-data-nodal-retiro">
        Descuento:
        <span class="Descuento-producto-modal" id="Descuento_producto_modal">0.00</span>
        <span class="Precio-producto-modal-simbolo" id="Simbolo_Precio_producto_modal">Bs</span>
        </label>  

        <label class="containner-data-nodal-retiro">
        Cantidad:
        <input type="number" class="cantidad" id="cantidad" min="1" value="1">
        </label> 

        <label class="containner-data-nodal-retiro">
        Precio:
        <span class="Precio-producto-modal" id="Precio_total_producto_modal">0.00</span>
        <span class="Precio-producto-modal-simbolo" id="Simbolo_Precio_producto_modal">Bs</span>
        </label>
        <button class="btn-cerrar-modal"onclick="cerrarModal()">Aceptar</button>
    </div>
</div>
<!----------------------------------->
<div id="miModal" class="modal">

    <div class="modal-content">
        <h2>Datos de la Persona</h2>
        <form id="formularioPersona">
            <div class="containner-label-comprador">
                <label for="nombre">Nombre Completo:</label>
                <input type="text" id="nombre" name="nombre" required> 
            </div>
         
            <div class="containner-label-comprador">
                 <label for="ci">Cédula de Identidad (C.I.):</label>
                 <input type="text" id="ci" name="ci" required>
            </div>
           
            <div class="containner-label-comprador">
                <label for="tlf">Teléfono (Tlf):</label>
                <input type="text" id="tlf" name="tlf" required>
            </div>
           
            <div class="containner-label-comprador" style="padding: 2px; display: flex; align-items: center; justify-content: center; ">
             <button type="submit" class="btn-guardar-venta">Guardar Datos</button>
            </div>
            
        </form>
    </div>

</div>
<!----------------------------------->
</section>
<script type="text/javascript" src="../../assets/icoMoon/selection.json"></script>
<script type="text/javascript">
let List_Productos_retiro=[];

let btn_Buscar = document.getElementById("btn-Buscar");
    btn_Buscar.focus();
    btn_Buscar.addEventListener('click', function(evt){

        if(document.getElementById("inputSearch").value!==""){
                       console.log("buscar")
            console.log(document.getElementById("list_product_retiro").children.length)
            api.send("Buscar-producto-retiro",document.getElementById("inputSearch").value)
            document.getElementById("inputSearch").value="";
        }
    })

/*-------------------------------------------------*/

document.getElementById("inputSearch").addEventListener("search", function(e) { 
              
    if(document.getElementById("inputSearch").value==""){

    }else{
    
                console.log("buscar")
                api.send("Buscar-producto-retiro",document.getElementById("inputSearch").value)
                document.getElementById("inputSearch").value="";
        
    }                                       
})


api.receive("productos-data-retiro",(event, data_producto)=>{

    abrirModal(data_producto[0]);

})

let btn_Aceptar = document.getElementById("btn-Aceptar");
    btn_Aceptar.addEventListener('click', function(evt){

        if(document.getElementById("list_product_retiro").children.length>0){
            AbrirModalDatosComprador()
        }
    })


let btn_reset = document.getElementById("btn-Limpiar");
    btn_reset.addEventListener('click', function(evt){

    List_Productos_retiro=[]
    document.getElementById("list_product_retiro").innerHTML="";

    })


/*----------------------------------------------------------------*/

function abrirModal(data) {

    document.getElementById("modalOverlay").style.display = "flex";
    document.getElementById("cantidad").focus();
    /*------------------------------------------*/
    document.getElementById("cod_modal_producto").innerHTML=data.cod;
    document.getElementById("nombre_modal_producto").innerHTML=data.nombre;
    document.getElementById("Descuento_producto_modal").innerHTML=data.descuento.toFixed(2);
    document.getElementById("Precio_producto_modal").innerHTML=data.precio.toFixed(2);
    /*--------------------------------*/

    document.getElementById("cantidad").onclick=function(){
       let cant = document.getElementById("cantidad").value

        document.getElementById("Precio_total_producto_modal").innerHTML=((parseFloat(data.precio)-parseFloat(data.descuento))*parseFloat(cant)).toFixed(2);
    }

    document.getElementById("Precio_total_producto_modal").innerHTML=((parseFloat(data.precio)-parseFloat(data.descuento))*parseFloat(document.getElementById("cantidad").value)).toFixed(2);

}

document.getElementById("modalOverlay").addEventListener('keydown', manejarCierreConEnter);

function manejarCierreConEnter(event) {
  if (event.key === 'Enter' || event.keyCode === 13) {
    
    cerrarModal();

  }
}

function cerrarModal(){

      document.getElementById("modalOverlay").style.display = "none";

      let producto ={
            cod:document.getElementById("cod_modal_producto").innerHTML,
            nombre:document.getElementById("nombre_modal_producto").innerHTML,
            precio:document.getElementById("Precio_producto_modal").innerHTML,
            descuento:document.getElementById("Descuento_producto_modal").innerHTML,
            cant:document.getElementById("cantidad").value,
            preciototal:document.getElementById("Precio_total_producto_modal").innerHTML
      }

      List_Productos_retiro.push(producto)
      /*---------------------------------------*/
        Render_data(List_Productos_retiro)
        calculos_resultados(List_Productos_retiro)

}


function Render_data(List_Productos_retiro){
  
    document.getElementById("list_product_retiro").innerHTML="";
     List_Productos_retiro.forEach((producto,index)=>{

                document.getElementById("list_product_retiro").innerHTML+=`<article class="article-product-data">
                        <span class="item-product-data">${index}</span>
                        <span class="item-product-data">${producto.cod}</span>
                        <span class="item-product-data">${producto.nombre}</span>
                        <span class="item-product-data">${producto.precio}</span>
                        <span class="item-product-data">${producto.descuento}</span>
                        <span class="item-product-data">${producto.cant}</span>
                        <span class="item-product-data">${producto.preciototal}</span>
                        <span class="item-product-data action">
                            <button class="btn-action-producto borrar-article icon-bin2" onclick="BorrarProducto('${producto.cod}')"></button> </span>
                    </article>`;
      })


}


function BorrarProducto(cod){

        console.log(List_Productos_retiro)

        let newarray = eliminarObjetoPorCod(List_Productos_retiro, cod)

        List_Productos_retiro=newarray
        Render_data(List_Productos_retiro)
        calculos_resultados(List_Productos_retiro)

}

function eliminarObjetoPorCod(array, codAEliminar) {

    return array.filter(objeto => objeto.cod !== codAEliminar);
}


/*----------------------------------------------------------------*/

let Total_producto = 0;
let Total_cantidad = 0;

function calculos_resultados(producto){

    console.log(producto)

    Total_producto = 0;
    Total_cantidad = 0;

    for(let i=0;i<producto.length;i++){

        Total_producto = Total_producto+parseFloat(producto[i].preciototal)
        Total_cantidad = Total_cantidad+parseFloat(producto[i].cant)

    }

    document.getElementById("Precio_Total").innerHTML = Total_producto
    document.getElementById("cantidad_total_producto").innerHTML = Total_cantidad
}


/*----------------------------------------------------------------*/

function AbrirModalDatosComprador() {
    var modal = document.getElementById("miModal");
    modal.style.display = "block";
}


function CerrarModalDatosComprador() {
  
     var modal = document.getElementById("miModal");
    modal.style.display = "none";
}

        // Manejar el envío del formulario (opcional, para demostrar la captura de datos)
document.getElementById("formularioPersona").onsubmit = function(event) {
            event.preventDefault(); // Evita que la página se recargue

            /*----------------------------------------*/
                        
                //console.log(List_Productos_retiro)
                let data = {
                        comprador:{
                            nombre:document.getElementById('nombre').value,
                            ci:document.getElementById('ci').value,
                            tlf:document.getElementById('tlf').value
                        },
                        productos:List_Productos_retiro
                }
             /*----------------------------------------*/
                
              api.send("guardar-informacion-de-transacion",data)

                 /*----------------------------------------*/
                
            CerrarModalDatosComprador()
            /*---------------------------------------------*/
            List_Productos_retiro=[]
            document.getElementById("inputSearch").value="";
            document.getElementById("list_product_retiro").innerHTML="";
            document.getElementById("Precio_Total").innerHTML = 0.00;
            document.getElementById("cantidad_total_producto").innerHTML = 0;
}


/*------------------------------------------------------------------------------*/
// Función para obtener el valor de 1 USD en bolívares
async function obtenerCambioUSD() {
  try {
    const respuesta = await fetch("https://ve.dolarapi.com/v1/dolares/oficial");
    const datos = await respuesta.json();

    console.log(datos)

        return datos.promedio;

  } catch (error) {
    console.error("Error al obtener el cambio:", error);
    return null;
  }
}

// Uso de la función
obtenerCambioUSD().then(valor => {
  document.getElementById("data-ventana1-info").innerHTML=`1 USD = ${valor} Bs`
});


function programarFuncionDiaria(funcionAEjecutar, horas) {
    const ahora = new Date();
    const hoy = ahora.getDate();
    const esteMes = ahora.getMonth();
    const esteAnio = ahora.getFullYear();
    const tiempoActualMs = ahora.getTime();

    // 1. Encontrar el próximo momento de ejecución
    let proximaEjecucionMs = Infinity;

    // Buscar la hora de hoy más cercana en el futuro
    for (const hora of horas) {
        // Creamos un objeto Date para la hora programada de hoy
        const tiempoProgramado = new Date(esteAnio, esteMes, hoy, hora, 0, 0, 0);
        const tiempoProgramadoMs = tiempoProgramado.getTime();

        if (tiempoProgramadoMs > tiempoActualMs) {
            // Es una hora en el futuro hoy
            proximaEjecucionMs = Math.min(proximaEjecucionMs, tiempoProgramadoMs);
        }
    }

    // 2. Si no hay más horas hoy, programar para la primera hora de mañana
    if (proximaEjecucionMs === Infinity) {
        // Ordenamos las horas para encontrar la primera hora de mañana
        horas.sort((a, b) => a - b);
        const primeraHoraManana = horas[0];
        const manana = new Date(esteAnio, esteMes, hoy + 1, primeraHoraManana, 0, 0, 0);
        proximaEjecucionMs = manana.getTime();
    }

    // 3. Calcular el retraso y programar
    const retrasoMs = proximaEjecucionMs - tiempoActualMs;

    console.log(`Función programada para: ${new Date(proximaEjecucionMs).toLocaleTimeString()}`);

    // Usamos setTimeout para esperar hasta la hora programada
    setTimeout(() => {
        // Ejecutar la función deseada
        funcionAEjecutar();

        // Volver a programar para el próximo ciclo
        programarFuncionDiaria(funcionAEjecutar, horas);
    }, retrasoMs);
}

// --- Uso de la función ---

// 1. Define la función que quieres ejecutar
const miFuncion = () => {
    //console.log(`¡La función se ejecutó a las ${new Date().toLocaleTimeString()}!`);
    // Aquí iría el código real que quieres que se ejecute a las 3 PM o 5 PM

    /*----------------------------------------*/
    // Uso de la función
    obtenerCambioUSD().then(valor => {
      document.getElementById("data-ventana1-info").innerHTML=`1 USD = ${valor} Bs`
    });
    /*----------------------------------------*/

};

// 2. Llama a la función de programación
// Las horas se especifican en formato 24 horas: 15 (3 PM) y 17 (5 PM).
programarFuncionDiaria(miFuncion, [15, 17]);

/*------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------*/
function actualizarReloj() {
    // 1. Obtener la fecha y hora actuales
    const ahora = new Date();

    // 2. Extraer horas, minutos y segundos
    const horas = ahora.getHours();
    const minutos = ahora.getMinutes();
    const segundos = ahora.getSeconds();

    // 3. Formatear para añadir un cero inicial si es menor a 10
    // La función padStart(2, '0') asegura que el número tenga al menos 2 dígitos
    // (ej: 5 se convierte en '05')
    const formatoHoras = String(horas).padStart(2, '0');
    const formatoMinutos = String(minutos).padStart(2, '0');
    const formatoSegundos = String(segundos).padStart(2, '0');

    // 4. Crear la cadena de texto de la hora (HH:MM:SS)
    const tiempoActual = `${formatoHoras}:${formatoMinutos}:${formatoSegundos}`;

    // 5. Mostrar la hora en el elemento HTML
    const elementoReloj = document.getElementById('reloj');
    elementoReloj.textContent = tiempoActual;
}

// 6. Configurar la actualización del reloj
// setInterval() llama a la función actualizarReloj cada 1000 milisegundos (1 segundo)
setInterval(actualizarReloj, 1000);

// Llamar a la función inmediatamente al cargar la página para evitar un retraso inicial
actualizarReloj();
</script>
 
